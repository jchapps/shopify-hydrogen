import{r as l,j as Ar,C as h}from"./index.3aad892f.js";import{C as lr,u as yr,i as B,s as _r,a as Rr}from"./17eda71b.js";import{u as Cr,C as fr,a as or,b as pr,c as Ir,d as Dr,e as Ur,f as br,g as Or,h as gr,i as hr}from"./bc13da9a.js";import{f as Pr}from"./92add5bc.js";import"./67c97115.js";import"./0e14c04e.js";import"./2f38b294.js";import"./d6282b27.js";function Nr({numCartLines:r,cartFragment:a,countryCode:t=lr.Us}){const e=Cr(),n=l.exports.useCallback(T=>e({query:fr(a),variables:{id:T,numCartLines:r,country:t}}),[e,a,r,t]),U=l.exports.useCallback(T=>e({query:or(a),variables:{input:T,numCartLines:r,country:t}}),[a,t,e,r]),D=l.exports.useCallback((T,y)=>e({query:pr(a),variables:{cartId:T,lines:y,numCartLines:r,country:t}}),[a,t,e,r]),O=l.exports.useCallback((T,y)=>e({query:Ir(a),variables:{cartId:T,lines:y,numCartLines:r,country:t}}),[a,t,e,r]),P=l.exports.useCallback((T,y)=>e({query:Dr(a),variables:{cartId:T,lines:y,numCartLines:r,country:t}}),[a,t,e,r]),N=l.exports.useCallback((T,y)=>e({query:Ur(a),variables:{cartId:T,note:y,numCartLines:r,country:t}}),[e,a,r,t]),w=l.exports.useCallback((T,y)=>e({query:br(a),variables:{cartId:T,buyerIdentity:y,numCartLines:r,country:t}}),[a,t,e,r]),S=l.exports.useCallback((T,y)=>e({query:Or(a),variables:{cartId:T,attributes:y,numCartLines:r,country:t}}),[a,t,e,r]),M=l.exports.useCallback((T,y)=>e({query:gr(a),variables:{cartId:T,discountCodes:y,numCartLines:r,country:t}}),[a,t,e,r]);return l.exports.useMemo(()=>({cartFetch:n,cartCreate:U,cartLineAdd:D,cartLineUpdate:O,cartLineRemove:P,noteUpdate:N,buyerIdentityUpdate:w,cartAttributesUpdate:S,discountCodesUpdate:M,cartFragment:a}),[n,U,D,O,P,N,w,S,M,a])}function V(r,a){return{entry:[...(a==null?void 0:a.entryActions)||[],B({lastValidCart:t=>t==null?void 0:t.cart}),"onCartActionEntry","onCartActionOptimisticUI",r],on:{RESOLVE:{target:(a==null?void 0:a.resolveTarget)||"idle",actions:[B({prevCart:t=>t==null?void 0:t.lastValidCart,cart:(t,e)=>{var n;return(n=e==null?void 0:e.payload)==null?void 0:n.cart},rawCartResult:(t,e)=>{var n;return(n=e==null?void 0:e.payload)==null?void 0:n.rawCartResult},errors:t=>{}})]},ERROR:{target:(a==null?void 0:a.errorTarget)||"error",actions:[B({prevCart:t=>t==null?void 0:t.lastValidCart,cart:(t,e)=>t==null?void 0:t.lastValidCart,errors:(t,e)=>{var n;return(n=e==null?void 0:e.payload)==null?void 0:n.errors}})]},CART_COMPLETED:{target:"cartCompleted",actions:B({prevCart:t=>{},cart:t=>{},lastValidCart:t=>{},rawCartResult:t=>{},errors:t=>{}})}},exit:["onCartActionComplete",...(a==null?void 0:a.exitActions)||[]]}}const H={CART_FETCH:{target:"cartFetching"},CART_CREATE:{target:"cartCreating"},CART_SET:{target:"idle",actions:[B({rawCartResult:(r,a)=>a.payload.cart,cart:(r,a)=>J(a.payload.cart)})]}},ur={CARTLINE_ADD:{target:"cartLineAdding"},CARTLINE_UPDATE:{target:"cartLineUpdating"},CARTLINE_REMOVE:{target:"cartLineRemoving"},NOTE_UPDATE:{target:"noteUpdating"},BUYER_IDENTITY_UPDATE:{target:"buyerIdentityUpdating"},CART_ATTRIBUTES_UPDATE:{target:"cartAttributesUpdating"},DISCOUNT_CODES_UPDATE:{target:"discountCodesUpdating"}};function wr(r){return _r({id:"Cart",initial:r?"idle":"uninitialized",context:{cart:r&&J(r)},states:{uninitialized:{on:H},cartCompleted:{on:H},initializationError:{on:H},idle:{on:{...H,...ur}},error:{on:{...H,...ur}},cartFetching:V("cartFetchAction",{errorTarget:"initializationError"}),cartCreating:V("cartCreateAction",{errorTarget:"initializationError"}),cartLineRemoving:V("cartLineRemoveAction"),cartLineUpdating:V("cartLineUpdateAction"),cartLineAdding:V("cartLineAddAction"),noteUpdating:V("noteUpdateAction"),buyerIdentityUpdating:V("buyerIdentityUpdateAction"),cartAttributesUpdating:V("cartAttributesUpdateAction"),discountCodesUpdating:V("discountCodesUpdateAction")}})}function Sr({numCartLines:r,onCartActionEntry:a,onCartActionOptimisticUI:t,onCartActionComplete:e,data:n,cartFragment:U,countryCode:D}){const{cartFetch:O,cartCreate:P,cartLineAdd:N,cartLineUpdate:w,cartLineRemove:S,noteUpdate:M,buyerIdentityUpdate:T,cartAttributesUpdate:y,discountCodesUpdate:k}=Nr({numCartLines:r,cartFragment:U,countryCode:D}),q=l.exports.useMemo(()=>wr(n),[n]),[Y,p,v]=yr(q,{actions:{cartFetchAction:async(i,s)=>{var E;if(s.type!=="CART_FETCH")return;const{data:u,errors:R}=await O((E=s==null?void 0:s.payload)==null?void 0:E.cartId),C=L(s,u==null?void 0:u.cart,R);p(C)},cartCreateAction:async(i,s)=>{var E;if(s.type!=="CART_CREATE")return;const{data:u,errors:R}=await P(s==null?void 0:s.payload),C=L(s,(E=u==null?void 0:u.cartCreate)==null?void 0:E.cart,R);p(C)},cartLineAddAction:async(i,s)=>{var E,d;if(s.type!=="CARTLINE_ADD"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await N(i.cart.id,s.payload.lines),C=L(s,(d=u==null?void 0:u.cartLinesAdd)==null?void 0:d.cart,R);p(C)},cartLineUpdateAction:async(i,s)=>{var E,d;if(s.type!=="CARTLINE_UPDATE"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await w(i.cart.id,s.payload.lines),C=L(s,(d=u==null?void 0:u.cartLinesUpdate)==null?void 0:d.cart,R);p(C)},cartLineRemoveAction:async(i,s)=>{var E,d;if(s.type!=="CARTLINE_REMOVE"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await S(i.cart.id,s.payload.lines),C=L(s,(d=u==null?void 0:u.cartLinesRemove)==null?void 0:d.cart,R);p(C)},noteUpdateAction:async(i,s)=>{var E,d;if(s.type!=="NOTE_UPDATE"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await M(i.cart.id,s.payload.note),C=L(s,(d=u==null?void 0:u.cartNoteUpdate)==null?void 0:d.cart,R);p(C)},buyerIdentityUpdateAction:async(i,s)=>{var E,d;if(s.type!=="BUYER_IDENTITY_UPDATE"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await T(i.cart.id,s.payload.buyerIdentity),C=L(s,(d=u==null?void 0:u.cartBuyerIdentityUpdate)==null?void 0:d.cart,R);p(C)},cartAttributesUpdateAction:async(i,s)=>{var E,d;if(s.type!=="CART_ATTRIBUTES_UPDATE"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await y(i.cart.id,s.payload.attributes),C=L(s,(d=u==null?void 0:u.cartAttributesUpdate)==null?void 0:d.cart,R);p(C)},discountCodesUpdateAction:async(i,s)=>{var E,d;if(s.type!=="DISCOUNT_CODES_UPDATE"||!((E=i==null?void 0:i.cart)!=null&&E.id))return;const{data:u,errors:R}=await k(i.cart.id,s.payload.discountCodes),C=L(s,(d=u==null?void 0:u.cartDiscountCodesUpdate)==null?void 0:d.cart,R);p(C)},...a&&{onCartActionEntry:(i,s)=>{Mr(s)&&a(i,s)}},...t&&{onCartActionOptimisticUI:B((i,s)=>t(i,s))},...e&&{onCartActionComplete:(i,s)=>{Vr(s)&&e(i,s)}}}});return l.exports.useMemo(()=>[Y,p,v],[Y,p,v])}function J(r){var a;return{...r,lines:Pr(r.lines),note:(a=r.note)!=null?a:void 0}}function L(r,a,t){return t?{type:"ERROR",payload:{errors:t,cartActionEvent:r}}:a?{type:"RESOLVE",payload:{cart:J(a),rawCartResult:a,cartActionEvent:r}}:{type:"CART_COMPLETED",payload:{cartActionEvent:r}}}function Mr(r){return r.type==="CART_CREATE"||r.type==="CARTLINE_ADD"||r.type==="CARTLINE_UPDATE"||r.type==="CARTLINE_REMOVE"||r.type==="NOTE_UPDATE"||r.type==="BUYER_IDENTITY_UPDATE"||r.type==="CART_ATTRIBUTES_UPDATE"||r.type==="DISCOUNT_CODES_UPDATE"}function Vr(r){return r.type==="RESOLVE"||r.type==="ERROR"||r.type==="CART_COMPLETED"}const Z="shopifyCartId";function Xr({children:r,numCartLines:a,onCreate:t,onLineAdd:e,onLineRemove:n,onLineUpdate:U,onNoteUpdate:D,onBuyerIdentityUpdate:O,onAttributesUpdate:P,onDiscountCodesUpdate:N,onCreateComplete:w,onLineAddComplete:S,onLineRemoveComplete:M,onLineUpdateComplete:T,onNoteUpdateComplete:y,onBuyerIdentityUpdateComplete:k,onAttributesUpdateComplete:q,onDiscountCodesUpdateComplete:Y,data:p,cartFragment:v=hr,customerAccessToken:i,countryCode:s=lr.Us}){var x,m,rr,ar,tr,sr,ir;s&&(s=s.toUpperCase());const[u,R]=l.exports.useState(s),[C,E]=l.exports.useState(i),d=l.exports.useRef(!1);(u!==s||C!==i)&&(R(s),E(i),d.current=!1);const Er=l.exports.useCallback((c,f)=>{try{switch(f.type){case"CART_CREATE":return t==null?void 0:t();case"CARTLINE_ADD":return e==null?void 0:e();case"CARTLINE_REMOVE":return n==null?void 0:n();case"CARTLINE_UPDATE":return U==null?void 0:U();case"NOTE_UPDATE":return D==null?void 0:D();case"BUYER_IDENTITY_UPDATE":return O==null?void 0:O();case"CART_ATTRIBUTES_UPDATE":return P==null?void 0:P();case"DISCOUNT_CODES_UPDATE":return N==null?void 0:N()}}catch(A){console.error("Cart entry action failed",A)}},[P,O,t,N,e,n,U,D]),dr=l.exports.useCallback((c,f)=>{var A;if(!c.cart)return{...c};switch(f.type){case"CARTLINE_REMOVE":return{...c,cart:{...c.cart,lines:c.cart.lines.filter(({id:b})=>!f.payload.lines.includes(b))}};case"CARTLINE_UPDATE":return{...c,cart:{...c.cart,lines:(A=c==null?void 0:c.cart)==null?void 0:A.lines.map(b=>{const Q=f.payload.lines.find(({id:j})=>j===b.id);return Q&&Q.quantity?{...b,quantity:Q.quantity}:b})}}}return{...c}},[]),Tr=l.exports.useCallback((c,f)=>{const A=f.payload.cartActionEvent;try{switch(f.type){case"RESOLVE":switch(A.type){case"CART_CREATE":return qr(c,A),w==null?void 0:w();case"CARTLINE_ADD":return vr(c,A),S==null?void 0:S();case"CARTLINE_REMOVE":return Qr(c,A),M==null?void 0:M();case"CARTLINE_UPDATE":return zr(c,A),T==null?void 0:T();case"NOTE_UPDATE":return y==null?void 0:y();case"BUYER_IDENTITY_UPDATE":return kr(c,A)&&(d.current=!0),k==null?void 0:k();case"CART_ATTRIBUTES_UPDATE":return q==null?void 0:q();case"DISCOUNT_CODES_UPDATE":return Br(c,A),Y==null?void 0:Y()}}}catch(b){console.error("onCartActionComplete failed",b)}},[q,k,w,Y,S,M,T,y]),[o,z]=Sr({numCartLines:a,data:p,cartFragment:v,countryCode:s,onCartActionEntry:Er,onCartActionOptimisticUI:dr,onCartActionComplete:Tr}),G=l.exports.useRef(!1),W=o.matches("cartCompleted"),X=(o.value==="idle"||o.value==="error"||o.value==="cartCompleted")&&s!==((rr=(m=(x=o==null?void 0:o.context)==null?void 0:x.cart)==null?void 0:m.buyerIdentity)==null?void 0:rr.countryCode)&&!o.context.errors,$=l.exports.useRef(!1);l.exports.useEffect(()=>{if(!G.current&&!$.current){if(!p&&F("localStorage")){$.current=!0;try{const c=window.localStorage.getItem(Z);c&&z({type:"CART_FETCH",payload:{cartId:c}})}catch(c){console.warn("error fetching cartId"),console.warn(c)}}G.current=!0}},[p,G,z]),l.exports.useEffect(()=>{!X||d.current||z({type:"BUYER_IDENTITY_UPDATE",payload:{buyerIdentity:{countryCode:s,customerAccessToken:i}}})},[s,i,X,d,z]);const g=l.exports.useCallback(c=>{if(!G.current)return console.warn("Cart isn't ready yet");z(c)},[z]);l.exports.useEffect(()=>{var c,f,A;if(((f=(c=o==null?void 0:o.context)==null?void 0:c.cart)==null?void 0:f.id)&&F("localStorage"))try{window.localStorage.setItem(Z,(A=o.context.cart)==null?void 0:A.id)}catch(b){console.warn("Failed to save cartId to localStorage",b)}},[(tr=(ar=o==null?void 0:o.context)==null?void 0:ar.cart)==null?void 0:tr.id]),l.exports.useEffect(()=>{if(W&&F("localStorage"))try{window.localStorage.removeItem(Z)}catch(c){console.warn("Failed to delete cartId from localStorage",c)}},[W]);const K=l.exports.useCallback(c=>{var f,A;s&&!((f=c.buyerIdentity)!=null&&f.countryCode)&&(c.buyerIdentity==null&&(c.buyerIdentity={}),c.buyerIdentity.countryCode=s),i&&!((A=c.buyerIdentity)!=null&&A.customerAccessToken)&&(c.buyerIdentity==null&&(c.buyerIdentity={}),c.buyerIdentity.customerAccessToken=i),g({type:"CART_CREATE",payload:c})},[s,i,g]),_=Yr(o),nr=l.exports.useMemo(()=>{var c,f,A,b,Q,j;return{...(f=(c=_==null?void 0:_.context)==null?void 0:c.cart)!=null?f:{lines:[],attributes:[]},status:Lr(_.value),error:(A=_==null?void 0:_.context)==null?void 0:A.errors,totalQuantity:(j=(Q=(b=_==null?void 0:_.context)==null?void 0:b.cart)==null?void 0:Q.totalQuantity)!=null?j:0,cartCreate:K,linesAdd(I){var er,cr;(cr=(er=_==null?void 0:_.context)==null?void 0:er.cart)!=null&&cr.id?g({type:"CARTLINE_ADD",payload:{lines:I}}):K({lines:I})},linesRemove(I){g({type:"CARTLINE_REMOVE",payload:{lines:I}})},linesUpdate(I){g({type:"CARTLINE_UPDATE",payload:{lines:I}})},noteUpdate(I){g({type:"NOTE_UPDATE",payload:{note:I}})},buyerIdentityUpdate(I){g({type:"BUYER_IDENTITY_UPDATE",payload:{buyerIdentity:I}})},cartAttributesUpdate(I){g({type:"CART_ATTRIBUTES_UPDATE",payload:{attributes:I}})},discountCodesUpdate(I){g({type:"DISCOUNT_CODES_UPDATE",payload:{discountCodes:I}})},cartFragment:v}},[K,(sr=_==null?void 0:_.context)==null?void 0:sr.cart,(ir=_==null?void 0:_.context)==null?void 0:ir.errors,_.value,v,g]);return Ar(Rr.Provider,{value:nr,children:r})}function Lr(r){switch(r){case"uninitialized":case"initializationError":return"uninitialized";case"idle":case"cartCompleted":case"error":return"idle";case"cartFetching":return"fetching";case"cartCreating":return"creating";case"cartLineAdding":case"cartLineRemoving":case"cartLineUpdating":case"noteUpdating":case"buyerIdentityUpdating":case"cartAttributesUpdating":case"discountCodesUpdating":return"updating"}}function Yr(r){const[a,t]=l.exports.useTransition(),[e,n]=l.exports.useState(r),U=l.exports.useRef(!1);a&&(U.current=!0);const D=l.exports.useRef(!1);return!a&&U.current&&(D.current=!0),l.exports.useEffect(()=>{t(()=>{D.current||n(r)})},[r]),D.current?r:e}function F(r){let a;try{a=window[r];const t="__storage_test__";return a.setItem(t,t),a.removeItem(t),!0}catch(t){return t instanceof DOMException&&(t.code===22||t.code===1014||t.name==="QuotaExceededError"||t.name==="NS_ERROR_DOM_QUOTA_REACHED")&&a&&a.length!==0}}function kr(r,a){var t,e;return a.payload.buyerIdentity.countryCode&&((e=(t=r.cart)==null?void 0:t.buyerIdentity)==null?void 0:e.countryCode)!==a.payload.buyerIdentity.countryCode}function qr(r,a){h.publish(h.eventNames.ADD_TO_CART,!0,{addedCartLines:a.payload.lines,cart:r.rawCartResult,prevCart:null})}function vr(r,a){h.publish(h.eventNames.ADD_TO_CART,!0,{addedCartLines:a.payload.lines,cart:r.rawCartResult,prevCart:r.prevCart})}function zr(r,a){h.publish(h.eventNames.UPDATE_CART,!0,{updatedCartLines:a.payload.lines,oldCart:r.prevCart,cart:r.rawCartResult,prevCart:r.prevCart})}function Qr(r,a){h.publish(h.eventNames.REMOVE_FROM_CART,!0,{removedCartLines:a.payload.lines,cart:r.rawCartResult,prevCart:r.prevCart})}function Br(r,a){h.publish(h.eventNames.DISCOUNT_CODE_UPDATED,!0,{updatedDiscountCodes:a.payload.discountCodes,cart:r.rawCartResult,prevCart:r.prevCart})}export{Xr as CartProvider};
//# sourceMappingURL=5c176f38.js.map
